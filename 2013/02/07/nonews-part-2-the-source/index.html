<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>NoNews Part II - The Source | Jason Straughan</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Jason Straughan is a web developer living in San Antonio, Texas that specializes in Ruby, Rails, and all things web.">
    <meta name="author" content="Jason D. Straughan (JDStraughan)">
    <link href='http://fonts.googleapis.com/css?family=Droid+Sans+Mono|Droid+Serif:700' rel='stylesheet' type='text/css'>
    <link href="http://jdstraughan.com/feed.xml" rel="alternate" type="application/rss+xml" title="JDStraughan | Rubyist, Web Developer, Disc Golfer" />
    <link href='/assets/global-adeb0279af96de1ec08f8c74c70c8ffa.css' rel='stylesheet' type='text/css' />

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

  <body>

    <div class="navbar navbar-inverse navbar-fixed-top">
        <div class="navbar-inner">
          <div class="container-fluid">
            <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </a>
            <a class="brand" href="/">JDStraughan.com</a>
            <div class="nav-collapse collapse">
              <ul class="nav pull-right">
                
                  
                    
                      <li class="active">
                    
                  
                
                  <a href="/">blog</a></li>  
                
                
                
  
    
      <li><a href="/about.html">about</a></li>
    
  

  

  

  

  
    
      <li><a href="/portfolio.html">portfolio</a></li>
    
  

  

  

  

  

  

  

  

  

  

  



              </ul>
            </div><!--/.nav-collapse -->
          </div>
        </div>
      </div>

    <div class="container-fluid">
      <div class="row-fluid">
        
        <div class="span9">
          <section class="main-content">
            <div class="content">
  <div id="post">
    <h1>NoNews Part II - The Source</h1>
    <h6>
      07 Feb 2013 | Tags: <a href="/tag/chrome%20extension.html">chrome extension</a>, <a href="/tag/javascript.html">javascript</a> 
    </h6>
    <hr>
    <p><a href="https://chrome.google.com/webstore/detail/no-news-is-good-news/fnikidjfogfllkinoahanihoddalbhil">NoNews is a Google Chrome extension</a> that I built to assist me (and you) in avoiding passively reading the news while casually surfing the web.  I wrote a <a href="http://jdstraughan.com/2013/01/29/nonews-is-good-news/">blog post about why I made it</a>, and explored the <a href="http://www.aaronsw.com/weblog/hatethenews">inspiration</a> behind the endeavor.  In this post I'd like to walk-through the <a href="https://github.com/JDStraughan/nonews">source code</a>, explain how the extension is constructed, and talk about things that can be done to improve the product.</p>

<p>This was my first attempt at creating a browser plugin, and I relied heavily on the <a href="http://developer.chrome.com/extensions/">developer documentation</a> provided by Google.  At first glance it seemed lacking, and while the organization and example code was not always fulfilling, the docs do provide all the information needed to begin the journey into extension creation. Being my first extension, I am not sure I followed all the best practices or chose the best route for accomplishing my task, however, with a small amount of code I was able to create a fully functioning plugin with a few features with very little time invested. Experienced extension developers: I look forward to your constructive criticism in the comments!</p>

<h2>The Code</h2>

<p>The biggest challenge I faced was understanding the difference between <a href="http://developer.chrome.com/extensions/manifestVersion.html">manifest versions 1 and 2</a>.  More importantly, I would find example code written for manifest v1, and attempt to make it work in v2.  This was the source of much frustration.  NoNews is written using manifest v2, so hopefully you don't have the same issues I did.</p>

<p>Note: if there are future updates and you need to match source code, this walkthrough is using <a href="https://github.com/JDStraughan/nonews/tags">tagged version 0.5 of NoNews</a>.</p>

<p>Speaking of manifest files, lets take a look at <code>manifest.json</code>:</p>

<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;No News (is Good News!)&quot;</span><span class="p">,</span>
  <span class="s2">&quot;manifest_version&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="s2">&quot;version&quot;</span><span class="o">:</span> <span class="s2">&quot;0.5&quot;</span><span class="p">,</span>
  <span class="s2">&quot;homepage_url&quot;</span> <span class="o">:</span> <span class="s2">&quot;http://www.nonews.info&quot;</span><span class="p">,</span>
  <span class="s2">&quot;description&quot;</span><span class="o">:</span> <span class="s2">&quot;Warns you of news pages that may ruin your day ;)&quot;</span><span class="p">,</span>
  <span class="s2">&quot;icons&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;16&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon16.png&quot;</span><span class="p">,</span>
             <span class="s2">&quot;48&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon48.png&quot;</span><span class="p">,</span>
            <span class="s2">&quot;128&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon128.png&quot;</span> <span class="p">},</span>
  <span class="s2">&quot;browser_action&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;default_icon&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;19&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon19.png&quot;</span><span class="p">,</span>
      <span class="s2">&quot;38&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon38.png&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;default_title&quot;</span><span class="o">:</span> <span class="s2">&quot;No News (is Good News!)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default_popup&quot;</span><span class="o">:</span> <span class="s2">&quot;html/popup.html&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;webRequest&quot;</span><span class="p">,</span> <span class="s2">&quot;webRequestBlocking&quot;</span><span class="p">,</span> <span class="s2">&quot;http://*/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://*/&quot;</span>
  <span class="p">],</span>
  <span class="s2">&quot;background&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;js/nonews.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>


<p>JSON should be familiar to all of us, and it is pretty easy to see what is going on for most of this file.  The manifest defines and configures things like the name, url, asset locations, permission settings, manifest_version, etc. We will need to refer back to this file though out the build to explain each section, but this is what the final product looks like. The developer docs have a great <a href="http://developer.chrome.com/extensions/manifest.html">summary of manifest options</a> that explains the different settings available.</p>

<p>It is also worth mentioning that there is not a strict directory structure for extensions, with many simply having all the files in the root directory.  For this extension, I am using a file structure that looks like this:</p>

<pre><code>.
├── README.md
├── assets
│   └── blacklist.json
├── changelog.txt
├── css
│   └── popup.css
├── html
│   └── popup.html
├── img
│   ├── icon128.png
│   ├── icon48.png
│   └── icon16.png
├── js
│   ├── nonews.js
│   └── popup.js
└── manifest.json
</code></pre>

<p>Most of this is self explanatory, but let's do a quick overview of the files.  The <code>README.md</code> file is there for GitHub, since this is an open-source project. Next up is the <code>assets</code> directory, which contains one file: <code>blacklist.json</code>.  This file is responsible for seeding the extension with a list of URLs that will be blocked by the browser.  The <code>css/popup.css</code>, <code>html/popup.html</code> and <code>js/popup.js</code> files generate the the popup display that occurs when a user places their mouse over the icon next to the address bar.  The icons listed in the <code>/img</code> directory fulfill the sizes required as shown <a href="http://developer.chrome.com/extensions/manifest.html#icons">here</a>.  The <code>js/nonews.js</code> file holds all the logic for our extension, and we are already familiar with the <code>manifest.json</code> file.</p>

<p>Now that we have the directory structure and manifest file out of the way, let's dive into the most important file in the extension: the event page.  The docs tell us that through v1, extensions had the option to run a background script that continually monitored and reacted on browser events.  In v2, we have the ability to set persistence on event pages - a persistent event page is a background page, and setting persistent to false let's us have an event page that is only loaded as needed.  For more information, read the <a href="http://developer.chrome.com/extensions/event_pages.html">documentation on event pages</a>.</p>

<p>Looking back at the <code>manifest.json</code> file, we see that we have a non-persistant background page located at <code>js/nonews.js</code>.</p>

<div class="highlight"><pre><code class="javascript">  <span class="p">...</span>
  <span class="s2">&quot;background&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;scripts&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;js/nonews.js&quot;</span><span class="p">]</span>
  <span class="p">}</span>
  <span class="p">...</span>
</code></pre></div>


<p>Since the default in v2 is <code>"persistence": false</code>, it is not being explicitly set here.  The docs tell us what this means in terms of when our extension will be loaded:</p>

<blockquote><ul>
<li>The extension is first installed or is updated to a new version (in order to register for events).</li>
<li>The event page was listening for an event, and the event is dispatched.</li>
<li>A content script or other extension sends a message.</li>
<li>Another view in the extension (for example, a popup) calls chrome.runtime.getBackgroundPage().</li>
</ul>
</blockquote>

<p>So this script is a perfect place to setup our extension, and add any event listeners we may need.  Let's take a loot at this event page.</p>

<h5>js/nonews.js</h5>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>   <span class="c1">// Get the file for the blacklist to load from json</span>
<span class="lineno"> 3</span>   <span class="kd">var</span> <span class="nx">fileURL</span> <span class="o">=</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getURL</span><span class="p">(</span><span class="s2">&quot;../assets/blacklist.json&quot;</span><span class="p">);</span> 
<span class="lineno"> 4</span>   <span class="kd">var</span> <span class="nx">xmlreq</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="lineno"> 5</span>   <span class="nx">xmlreq</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">fileURL</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="lineno"> 6</span>   <span class="nx">xmlreq</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>   <span class="c1">// The file should be in xmlreq.responseText</span>
<span class="lineno"> 9</span>   <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span> <span class="o">=</span> <span class="nx">xmlreq</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
<span class="lineno">10</span> <span class="p">}</span>
<span class="lineno">11</span> 
<span class="lineno">12</span> <span class="c1">// Add the event listener with filters</span>
<span class="lineno">13</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">webRequest</span><span class="p">.</span><span class="nx">onBeforeRequest</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span>
<span class="lineno">14</span>   <span class="kd">function</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">15</span>     <span class="c1">// Check for manual bypass via query string</span>
<span class="lineno">16</span>     <span class="k">if</span> <span class="p">(</span><span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;nonews_bypass=true&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">17</span>       <span class="k">return</span><span class="p">;</span>
<span class="lineno">18</span>     <span class="p">}</span>
<span class="lineno">19</span>     <span class="c1">// Check for snooze option</span>
<span class="lineno">20</span>     <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<span class="lineno">21</span>     <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_snooze_end</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno">22</span>       <span class="k">return</span><span class="p">;</span>
<span class="lineno">23</span>     <span class="p">}</span>
<span class="lineno">24</span>     <span class="c1">// Redirect to blocked site page, passing url for bypass option</span>
<span class="lineno">25</span>     <span class="k">return</span> <span class="p">{</span> 
<span class="lineno">26</span>       <span class="nx">redirectUrl</span><span class="o">:</span> <span class="s1">&#39;http://www.nonews.info/blocked-site.html?site=&#39;</span> <span class="o">+</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
<span class="lineno">27</span>     <span class="p">}</span>
<span class="lineno">28</span>   <span class="p">},</span>
<span class="lineno">29</span>   <span class="c1">// filters</span>
<span class="lineno">30</span>   <span class="p">{</span>
<span class="lineno">31</span>     <span class="nx">urls</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span><span class="p">),</span>
<span class="lineno">32</span>     <span class="nx">types</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;main_frame&quot;</span><span class="p">]</span>
<span class="lineno">33</span>   <span class="p">},</span>
<span class="lineno">34</span>   <span class="c1">// extratabSpec</span>
<span class="lineno">35</span>   <span class="p">[</span><span class="s2">&quot;blocking&quot;</span><span class="p">]</span>
<span class="lineno">36</span> <span class="p">);</span>
</code></pre></div>


<p>That, ladies and gentlemen, is the bulk of the code to make this extension work.  A handful of lines of native javascript using the Chrome API is all that is required to make this thing go.  Breaking it down into sections makes it easier to consume:</p>

<div class="highlight"><pre><code class="javascript"><span class="lineno"> 1</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span> <span class="o">===</span> <span class="s2">&quot;undefined&quot;</span><span class="p">)</span> <span class="p">{</span>
<span class="lineno"> 2</span>   <span class="c1">// Get the file for the blacklist to load from json</span>
<span class="lineno"> 3</span>   <span class="kd">var</span> <span class="nx">fileURL</span> <span class="o">=</span> <span class="nx">chrome</span><span class="p">.</span><span class="nx">extension</span><span class="p">.</span><span class="nx">getURL</span><span class="p">(</span><span class="s2">&quot;../assets/blacklist.json&quot;</span><span class="p">);</span> 
<span class="lineno"> 4</span>   <span class="kd">var</span> <span class="nx">xmlreq</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
<span class="lineno"> 5</span>   <span class="nx">xmlreq</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">fileURL</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
<span class="lineno"> 6</span>   <span class="nx">xmlreq</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>
<span class="lineno"> 7</span> 
<span class="lineno"> 8</span>   <span class="c1">// The file should be in xmlreq.responseText</span>
<span class="lineno"> 9</span>   <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span> <span class="o">=</span> <span class="nx">xmlreq</span><span class="p">.</span><span class="nx">responseText</span><span class="p">;</span>
<span class="lineno">10</span> <span class="p">}</span>
</code></pre></div>


<p>Starting with line 1, I am checking to see if we have already stored the blacklist into <a href="http://en.wikipedia.org/wiki/Web_storage#Local_and_session_storage">localStorage</a>.  This is not incredibly important for this version of the extension, as we could just load the blacklist into a variable that will be used in the event listener, however, adding to localStorage allows us to easily manipulate this list in the future, possibly through and <a href="">options page</a> interface.</p>

<p>If the black list is not already loaded, lines 3-6 use a <code>XMLHttpRequest</code> to load the <code>assets/blacklist.json</code> file.  Before we move on, let's take a quick look at the blacklist file:</p>

<div class="highlight"><pre><code class="javascript"><span class="p">{</span>
    <span class="s2">&quot;urls&quot;</span> <span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;*://*.10news.com/*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*://*.10tv.com/*&quot;</span><span class="p">,</span>
    
        <span class="p">...</span>
        
        <span class="s2">&quot;*://*.zoiksonline.com/*&quot;</span><span class="p">,</span>
        <span class="s2">&quot;*://*.zwire.com/*&quot;</span>
    <span class="p">]</span>
<span class="p">}</span>
</code></pre></div>


<p>The actual file is over 6300 lines long, containing most of the websites from <a href="http://www.labnol.org/tech/google-news-sources/19321/">this list of Google News sources</a>. I am sure you have observed that these are not URLs, rather they are <a href="http://developer.chrome.com/extensions/match_patterns.html">match patterns</a> that define our blacklist of sites.</p>

<p>In line 9 of the <code>nonews.js</code> file we see that the blacklist is loaded as a string into <code>localStorage</code>, and is now available for our extension to use.  Moving on we see the 2nd half of the event page:</p>

<div class="highlight"><pre><code class="javascript"><span class="c1">// Add the event listener with filters</span>
<span class="nx">chrome</span><span class="p">.</span><span class="nx">webRequest</span><span class="p">.</span><span class="nx">onBeforeRequest</span><span class="p">.</span><span class="nx">addListener</span><span class="p">(</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Check for manual bypass via query string</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;nonews_bypass=true&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Check for snooze option</span>
    <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_snooze_end</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Redirect to blocked site page, passing url for bypass option</span>
    <span class="k">return</span> <span class="p">{</span> 
      <span class="nx">redirectUrl</span><span class="o">:</span> <span class="s1">&#39;http://www.nonews.info/blocked-site.html?site=&#39;</span> <span class="o">+</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="c1">// filters</span>
  <span class="p">{</span>
    <span class="nx">urls</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span><span class="p">),</span>
    <span class="nx">types</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;main_frame&quot;</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="c1">// extratabSpec</span>
  <span class="p">[</span><span class="s2">&quot;blocking&quot;</span><span class="p">]</span>
<span class="p">);</span>
</code></pre></div>


<p>Here we are using the <a href="https://developer.chrome.com/extensions/webRequest.html">chrome.webRequest</a> module to create our filters. According to the docs:</p>

<blockquote><p>You must declare the "webRequest" permission in the extension manifest to use the web request API, along with host permissions for any hosts whose network requests you want to access.</p></blockquote>

<p>To accomplish this, we have this section in the <code>manifest.json</code> file:</p>

<div class="highlight"><pre><code class="javascript">  <span class="p">...</span>
  <span class="s2">&quot;permissions&quot;</span><span class="o">:</span> <span class="p">[</span>
      <span class="s2">&quot;webRequest&quot;</span><span class="p">,</span> <span class="s2">&quot;webRequestBlocking&quot;</span><span class="p">,</span> <span class="s2">&quot;http://*/&quot;</span><span class="p">,</span> <span class="s2">&quot;https://*/&quot;</span>
  <span class="p">],</span>
  <span class="p">...</span>
<span class="p">}</span>
</code></pre></div>


<p>This gives permission to <code>chrome.webRequest</code>, <code>chrome.webRequestBlocking</code>, and all URLs using <code>http|https</code>.  We'll be using <a href="https://developer.chrome.com/extensions/webRequest.html#type-BlockingResponse">webRequestBlocking</a> to stop the request from executing, and instead we'll redirect the user elsewhere.  Before we cover that, we back up and look at the event listener.</p>

<p>In the webRequest module, we are adding an event listener to the <code>onBeforeRequest</code> which the docs tell us:</p>

<blockquote><p>Fires when a request is about to occur. This event is sent before any TCP connection is made and can be used to cancel or redirect requests.</p></blockquote>

<p>That is exactly what we need to stop the browser from displaying a page that originates at a site in our blacklist. The <code>addListener</code> method is available via the <a href="https://developer.chrome.com/extensions/events.html">chrome.events</a> module, and the docs tell us:</p>

<blockquote><p>The argument to addListener() is always a function that you define to handle the event, but the parameters to the function depend on which event you're handling.</p></blockquote>

<p>In the case of <code>chrome.webRequest.onBeforeRequest</code>, the addListener method takes these arguments: <code>callback</code>, <code>filter</code>, and <code>opt_extraInfoSpec</code>. The callback is the anonymous function we are using as the first argument, we are passing an object listing our filtered URLs in the second argument, and an array containing one value, "blocking", in the third.</p>

<p>Working backwards, let's look at this "blocking" array first. The docs tell us:</p>

<blockquote><p>If the optional opt_extraInfoSpec array contains the string 'blocking' (only allowed for specific events), the callback function is handled synchronously. That means that the request is blocked until the callback function returns.</p></blockquote>

<p>Perfect! So if there is a match in the filters, the request will be blocked until the callback is completed.  Let's look at the filters next.</p>

<div class="highlight"><pre><code class="javascript">  <span class="p">...</span>
  <span class="c1">// filters</span>
  <span class="p">{</span>
    <span class="nx">urls</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_blacklist_urls</span><span class="p">),</span>
    <span class="nx">types</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;main_frame&quot;</span><span class="p">]</span>
  <span class="p">},</span>
  <span class="p">...</span>
</code></pre></div>


<p>The <a href="https://developer.chrome.com/extensions/webRequest.html#type-RequestFilter">request filter</a> requires a <code>urls</code> property containing a list of URLs or URL patterns, and has 3 optional properties.  We'll use the optional <code>types</code> property to define <code>main_frame</code> as the request type we are limiting our filter to.  Notice to assemble the list of urls, we are just parsing the locally stored string into a JSON format.</p>

<p>Finally, we are at the heart of the extension, the callback that will be fired when a request is blocked.</p>

<div class="highlight"><pre><code class="javascript">  <span class="p">...</span>
  <span class="kd">function</span><span class="p">(</span><span class="nx">tab</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Check for manual bypass via query string</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">tab</span><span class="p">.</span><span class="nx">url</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;nonews_bypass=true&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Check for snooze option</span>
    <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_snooze_end</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// Redirect to blocked site page, passing url for bypass option</span>
    <span class="k">return</span> <span class="p">{</span> 
      <span class="nx">redirectUrl</span><span class="o">:</span> <span class="s1">&#39;http://www.nonews.info/blocked-site.html?site=&#39;</span> <span class="o">+</span> <span class="nx">tab</span><span class="p">.</span><span class="nx">url</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="c1">// filters</span>
  <span class="p">...</span>
</code></pre></div>


<p>We are passing the <code>tab</code> object to the function so we can made some decisions based on the contents of that object.  Although we have not looked at the features for bypassing and snoozing the extension, the code is not incredibly difficult.</p>

<p>First, we are checking to see if the query string contains <code>nonews_bypass=true</code>, and if so, we are simply returning and allowing the browser to go on its merry way.</p>

<p>Next, we are setting <code>now</code> to reflect the current unix timestamp, and asserting that if there is a <code>localStorage</code> variable named <code>nonews_snooze_end</code>, and it is larger than <code>now</code>, then we get out of the way and let the user go.</p>

<p>If none of these conditions are met, we simply redirect the user to a web page that serves as the blocked page, and we pass a query string setting the original request URL.</p>

<p>The public facing site for NoNews is available in the <a href="https://github.com/JDStraughan/nonews/tree/website">website branch of the repository</a>. It is a simple, static HTML site that can be easily hosted on places like GitHub Pages or S3, so you will not need any special web server on you local machine to view.  Just open pages in your browser and you'll be good to go.</p>

<p>Currently, the blocked page looks like this:</p>

<p><img src="/img/nonews-blocked-site-screen-800.jpg" alt="Nonews Blocked Site Screen" /></p>

<h5 class="centered-text">Screenshot of blocked URL with red bypass button and snooze bar popup open.</h5>


<p>In this screen shot, you can see the red button on the blocked site page that touts the ability to allow you to continue on your way.  This is accomplished by some javascript in the website branch that creates a link using the original request URL with <code>nonews_bypass=true</code>added as part of the query string.  This creates a link that will successfully meet the requirement in the callback function to temporarily disable blocking for the request.</p>

<p>In the upper righthand portion of the image, we can see the NoNews snooze bar.  This area is created when someone clicks on the NoNews icon that is added to the right of the address bar.  Going back to the manifest we see:</p>

<div class="highlight"><pre><code class="javascript">  <span class="p">...</span>
  <span class="s2">&quot;browser_action&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;default_icon&quot;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&quot;19&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon19.png&quot;</span><span class="p">,</span>
      <span class="s2">&quot;38&quot;</span><span class="o">:</span> <span class="s2">&quot;img/icon38.png&quot;</span>
    <span class="p">},</span>
    <span class="s2">&quot;default_title&quot;</span><span class="o">:</span> <span class="s2">&quot;No News (is Good News!)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;default_popup&quot;</span><span class="o">:</span> <span class="s2">&quot;html/popup.html&quot;</span>
  <span class="p">},</span>
  <span class="p">...</span>
</code></pre></div>


<p>The <a href="http://developer.chrome.com/extensions/browserAction.html">browser action</a> module is described as:</p>

<blockquote><p>Use browser actions to put icons in the main Google Chrome toolbar, to the right of the address bar. In addition to its icon, a browser action can also have a tooltip, a badge, and a popup.</p></blockquote>

<p>The icons are defined by their names as a convention for Chrome to know their size.  The <code>default_title</code> will be the tool tip text shown on hover, and the <code>default_popup</code> contains the location of the page to be loaded when the icon is clicked.</p>

<h5>html/popup.html</h5>




<div class="highlight"><pre><code class="html"><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">type=</span><span class="s">&quot;text/css&quot;</span> <span class="na">href=</span><span class="s">&quot;../css/popup.css&quot;</span><span class="nt">&gt;</span>
<span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;popup&quot;</span><span class="nt">&gt;</span>
    <span class="nt">&lt;h3&gt;</span>No News (is Good News)<span class="nt">&lt;/h3&gt;</span>
    <span class="nt">&lt;p&gt;</span>
        A friendly reminder that reading the news is not always a good thing.
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>
        Inspiration: <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://www.aaronsw.com/weblog/hatethenews&quot;</span> <span class="na">target=</span><span class="s">&quot;_blank&quot;</span><span class="nt">&gt;</span>This essay<span class="nt">&lt;/a&gt;</span> by <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://en.wikipedia.org/wiki/Aaron_Swartz&quot;</span> <span class="na">target=</span><span class="s">&quot;_blank&quot;</span><span class="nt">&gt;</span>Aaron Swartz<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p&gt;</span>
        No News is open source! Visit our <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;https://github.com/jdstraughan/nonews&quot;</span> <span class="na">target=</span><span class="s">&quot;_blank&quot;</span><span class="nt">&gt;</span>GitHub Page<span class="nt">&lt;/a&gt;</span>.
    <span class="nt">&lt;/p&gt;</span>
    <span class="nt">&lt;p</span> <span class="na">id=</span><span class="s">&quot;snooze_container&quot;</span><span class="nt">&gt;&lt;p&gt;</span>
<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;../js/popup.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div>


<p>This is a pretty straightforward HTML file, with the only notable areas being the <code>snooze_container</code>, and the javascript file that is loaded at the end of the file.</p>

<h5>js/popup.js</h5>

<div class="highlight"><pre><code class="javascript"><span class="kd">var</span> <span class="nx">now</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">().</span><span class="nx">getTime</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">snooze_end</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_snooze_end</span><span class="p">;</span>
<span class="nx">setSnoozeContents</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">snooze_end</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;nonews_snooze&quot;</span><span class="p">);</span> 

<span class="k">if</span> <span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">el</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s2">&quot;click&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="nx">snooze</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">snooze_end</span><span class="p">)</span> <span class="p">});</span> 
<span class="p">}</span>

<span class="c1">// Set the snooze period to stop filter from blocking sites</span>
<span class="kd">function</span> <span class="nx">snooze</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">snooze_end</span><span class="p">)</span> <span class="p">{</span>
  
  <span class="c1">// Do nothing if stored is still valid</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">snooze_end</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// Set new snooze time (in unix timestamp (in milliseconds))</span>
  <span class="c1">// Set for 15 minutes in the future (90000ms = 15mins)</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_snooze_end</span> <span class="o">=</span> <span class="nx">now</span> <span class="o">+</span> <span class="mi">900000</span><span class="p">;</span>

  <span class="c1">// Update the class to reflect snooziness</span>
  <span class="nx">setSnoozeContents</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">nonews_snooze_end</span><span class="p">);</span>

<span class="p">}</span>

<span class="c1">// Human readable amount of time left in snooze period</span>
<span class="kd">function</span> <span class="nx">snoozeTimeRemaining</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">snooze_end</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">secs_remain</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">((</span><span class="nx">snooze_end</span> <span class="o">-</span> <span class="nx">now</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">secs_remain</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">secs_remain</span> <span class="o">+</span> <span class="s1">&#39; seconds&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">mins_remain</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">ceil</span><span class="p">(</span><span class="nx">secs_remain</span> <span class="o">/</span> <span class="mi">60</span><span class="p">);</span>
    <span class="nx">unit_of_measure</span> <span class="o">=</span> <span class="p">(</span><span class="nx">mins_remain</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39; minute&#39;</span> <span class="o">:</span> <span class="s1">&#39; minutes&#39;</span><span class="p">;</span> 
    <span class="k">return</span> <span class="nx">mins_remain</span> <span class="o">+</span> <span class="nx">unit_of_measure</span><span class="p">;</span> 
  <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Updates the snooze container with proper html to operate snooze bar</span>
<span class="kd">function</span> <span class="nx">setSnoozeContents</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">snooze_end</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">snooze_end</span> <span class="o">&gt;</span> <span class="nx">now</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">contents</span> <span class="o">=</span> <span class="s1">&#39;&lt;span class=&quot;snoozing&quot;&gt;NoNews is snoozing for  the next &#39;</span> <span class="o">+</span> <span class="nx">snoozeTimeRemaining</span><span class="p">(</span><span class="nx">now</span><span class="p">,</span> <span class="nx">snooze_end</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&lt;/span&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">contents</span> <span class="o">=</span> <span class="s1">&#39;&lt;button id=&quot;nonews_snooze&quot; href=&quot;#&quot;&gt;Snooze NoNews Filtering for 15 Minutes&lt;/button&gt;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">&quot;snooze_container&quot;</span><span class="p">).</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">contents</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>This file is not nearly as important for the core functionality of the extension, so I'll go over it in less detail.  This just handles the snooze functionality, more specifically: setting the snooze end time, and showing a snooze bar or a time remaining in a snooze cycle.</p>

<p>First, we set timestamps for <code>now</code>, and <code>snooze_end</code>.  Next, we create the contents of the snooze bar area with the <code>setSnoozeContents()</code> function.  This function fills the paragraph element with either a button that will be our snooze bar, or a reminder of how long is left in the current snooze cycle.</p>

<p>We then add an event listener to the snooze bar, if it exists, that calls the <code>snooze()</code> function on a click event.  First snooze checks to make sure it is not already snoozing, then sets the <code>localStorage.nonews_snooze_end</code> variable to 15 minutes in the future, in milliseconds.  Once this has been set, the <code>setSnoozeContents()</code> method is fired again, as the snooze bar needs to be replaced with the time remaining.</p>

<p>The <code>snoozeTimeRemaining()</code> function should be self-explanatory; it simply returns a human readable representation of time remaining until the snooze cycle is complete.</p>

<h2>What's next?</h2>

<p>This project is still in its infancy.  I hope.  I am using it now, and it is serving me well.  I would like to see some additional features, like an options page that allows the blacklist to be manipulated, or safe times to be set where the extension is automatically snoozed during certain times.  I've thought about adding importing and exporting of blacklists, custom whitelists, and custom redirect pages.  The list goes on.</p>

<p>I don't have to be the creator of all these new features.  The <a href="https://github.com/JDStraughan/nonews">NoNews extension is open-source</a>, and all pull requests will be considered for inclusion.</p>

<h2>Conclusion</h2>

<p>With a little bit of javascript, some time to delve into the documentation, and some experimentation, creating a browser extension can be a fun and rewarding process.  This extension is a very simplistic one, yet it served as a good introduction to how these things are constructed.</p>

<p>Paying attention to the permissions in the manifest file and exploring different aspects of the API was the key for me when poking around with the idea of making this extension.  I tried a few different ways to accomplish this task, and had fun breaking things and getting them all right again.  I hope this guide helps you in your browser extension adventures, and please leave any constructive criticism, improvements, or questions in the comments section below.</p>

  </div>
  
  <hr>
  
  
    <p>Previous post: <a href="/2013/01/29/nonews-is-good-news">NoNews (is Good News!)</a></p>
  
  
    <p>Next post: <a href="/2013/02/14/my-first-game-html5-lightcycles">My first game - HTML5 lightcycles</a></p>
  

  <hr>
    
  <div id="disqus_thread"></div>
  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'jdstraughan'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

  <hr>
  
  Related Posts
  <ul class="naked">
  
    <li><a href="/2013/03/05/html5-snake-with-source-code-walkthrough">HTML5 Snake source code walkthrough</a></li>
  
    <li><a href="/2013/02/14/my-first-game-html5-lightcycles">My first game - HTML5 lightcycles</a></li>
  
    <li><a href="/2013/01/29/nonews-is-good-news">NoNews (is Good News!)</a></li>
  
    <li><a href="/2013/01/28/jekyll-is-just-what-the-dr-ordered">Jekyll is just what the doctor ordered</a></li>
  
    <li><a href="/2013/03/14/homemade-ginger-ale-is-so-easy">Homemade Ginger Ale that is so easy (even a 7 year old can do it)</a></li>
  
    <li><a href="/2013/03/31/darth-vader-dreams-of-electric-sheep">Darth Vader Dreams of Electric Sheep</a></li>
  
  </ul>
</div>

          </section>
        </div><!--/span-->
        
        <div class="span3">

          <img src="/img/jason-straughan.png" width="183" height="275" alt="Jason Straughan" class="mypic">
          <h5 class="myname">Jason Straughan</h5>
          <p class="mybio">I live in the beautiful Texas hill country where I concentrate on building great web applications, writing, and enjoying time with my family. Recently I completed my first book, "Kohana 3.0 Beginner's Guide" for Packt Publishing.</p>
          
          <hr>
          
          <div class="contact-me">
            <a href="https://github.com/jdstraughan">
              <img src="/img/icons/Github.png" width="47" height="47" alt="Github">
            </a>
            <a href="https://twitter.com/jdstraughan">
              <img src="/img/icons/Twitter.png" width="47" height="47" alt="Twitter">
            </a>
            <a href="http://www.linkedin.com/in/jdstraughan/">
              <img src="/img/icons/LinkedIn.png" width="47" height="47" alt="LinkedIn">
            </a>
            <a href="http://jdstraughan.com/feed.xml">
              <img src="/img/icons/RSS.png" width="47" height="47" alt="RSS">
            </a>
            <a href="mailto:jasons@grok-interactive.com">
              <img src="/img/icons/Mail.png" width="47" height="47" alt="Mail">
            </a>
          </div>
                    
          <hr>
          
          <div class="grok">
            <a href="http://www.grok-interactive.com">
              <img src="/img/grok-transparent.png" width="143" height="59" alt="Grok Interactive, LLC">
              <p>We Grok the Web</p>  
            </a>
          </div>
          
          <hr>
          
          <h3>Recent Posts</h3>
          <ul class="naked">
          
           <li><a href="/2013/03/31/darth-vader-dreams-of-electric-sheep">Darth Vader Dreams of Electric Sheep</a></li>
          
           <li><a href="/2013/03/14/homemade-ginger-ale-is-so-easy">Homemade Ginger Ale that is so easy (even a 7 year old can do it)</a></li>
          
           <li><a href="/2013/03/05/html5-snake-with-source-code-walkthrough">HTML5 Snake source code walkthrough</a></li>
          
           <li><a href="/2013/02/14/my-first-game-html5-lightcycles">My first game - HTML5 lightcycles</a></li>
          
           <li><a href="/2013/02/07/nonews-part-2-the-source">NoNews Part II - The Source</a></li>
          
           <li><a href="/2013/01/29/nonews-is-good-news">NoNews (is Good News!)</a></li>
          
          </ul>
          
          <hr>
          
          <h3>Posts by Tag</h3>
          <div id="tag-cloud">
            <a href="/tag/chrome%20extension.html" class="set-2">chrome extension</a> <a href="/tag/cooking.html" class="set-1">cooking</a> <a href="/tag/game%20development.html" class="set-2">game development</a> <a href="/tag/general.html" class="set-1">general</a> <a href="/tag/html5.html" class="set-2">html5</a> <a href="/tag/javascript.html" class="set-5">javascript</a> <a href="/tag/jekyll.html" class="set-1">jekyll</a> <a href="/tag/soda%20making.html" class="set-1">soda making</a>
          </div>
          
        </div><!--/span-->
      </div><!--/row-->

      <hr>

      <footer>
        <p>&copy; 2012 Jason D. Straughan | JDStraughan.com</p>
        <p>Hosted for free on <a href="http://pages.github.com/">GitHub Pages</a> and powered by <a href="http://jekyllrb.com/">jekyll</a>.</p>
      </footer>

    </div><!--/.fluid-container-->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
    <script src='/assets/global-fce6899f5de9a0d1de2f5dafb8af0928.js' type='text/javascript'></script>

    <script src="//static.getclicky.com/js" type="text/javascript"></script>
    <script type="text/javascript">try{ clicky.init(66405120); }catch(e){}</script>
    <noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/66405120ns.gif" /></p></noscript>
  </body>
</html>
